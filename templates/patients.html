{% extends "layout.html" %}
{% block content %}

<!-- Header -->
<div class="bg-primary text-white p-3 d-flex justify-content-between align-items-center rounded-top">
  <h4 class="mb-0"><i class="bi bi-people-fill me-2"></i> Patient List</h4>
  <a href="{{ url_for('add_patient') }}" class="btn btn-light btn-sm fw-bold">
    <i class="bi bi-plus-circle"></i> New Patient
  </a>
</div>

<!-- Container -->
<div class="container py-4">

  <!-- Filters -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <select id="companyFilter" class="form-select">
        <option value="">Filter by Company (All)</option>
        {% for company in patients | selectattr('company', 'defined') | map(attribute='company') | reject('equalto', '') | unique | sort %}
          <option value="{{ company }}">{{ company }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-8">
      <div class="input-group">
        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control border-start-0" id="searchInput" placeholder="Search patients by name...">
      </div>
    </div>
  </div>

  <!-- Patient Count -->
  <p class="text-primary fw-bold text-center mb-4">{{ patients|length }} patient record(s)</p>

  <!-- Patient Cards -->
  {% for patient in patients %}
  <div class="card mb-3 shadow-sm border-0 patient-card" data-company="{{ patient.company | default('') }}">
    <div class="card-body d-flex align-items-center justify-content-between">

      <!-- Left: Avatar & Info -->
      <div class="d-flex align-items-center w-100">
        <img src="https://ui-avatars.com/api/?name={{ patient.first_name }}+{{ patient.last_name }}&background=0D8ABC&color=fff&size=64"
             alt="Avatar" class="avatar rounded-circle me-3">

        <div class="flex-grow-1">
          <h6 class="mb-1">
            <a href="{{ url_for('view_patient', patient_id=patient._id) }}"
               class="text-decoration-none fw-semibold text-primary">
              {{ patient.last_name }}, {{ patient.first_name }}
            </a>
          </h6>
          <p class="mb-1 text-muted small">{{ patient.contact or 'No contact info' }}</p>

          {% if patient.company %}
            <small class="badge bg-info text-dark mb-1">{{ patient.company }}</small><br>
          {% endif %}

          {% if patient.last_updated %}
            <small class="text-muted d-block">üïì Updated: {{ patient.last_updated.strftime('%b %d, %Y') }}</small>
          {% endif %}

          {% if patient.last_procedure and patient.procedure_date %}
            <small class="text-muted d-block">
              ü¶∑ Last Procedure: {{ patient.last_procedure }} ({{ patient.procedure_date.strftime('%b %d, %Y') }})
            </small>
          {% endif %}

          {% if patient.has_allergy %}
            <div class="mt-2">
              {% if patient.allergies %}
                {% if patient.allergies is string %}
                  <span class="badge bg-danger me-1">
                    <i class="bi bi-exclamation-circle-fill me-1"></i> {{ patient.allergies }}
                  </span>
                {% else %}
                  {% set valid_allergies = patient.allergies | select('string') | select('trim') | list %}
                  {% if valid_allergies %}
                    {% for allergy in valid_allergies %}
                      <span class="badge bg-danger me-1">
                        <i class="bi bi-exclamation-circle-fill me-1"></i> {{ allergy }}
                      </span>
                    {% endfor %}
                  {% else %}
                    <span class="badge bg-danger me-1">
                      <i class="bi bi-exclamation-circle-fill me-1"></i> ‚ö†Ô∏è Allergy info missing
                    </span>
                  {% endif %}
                {% endif %}
              {% else %}
                <span class="badge bg-danger me-1">
                  <i class="bi bi-exclamation-circle-fill me-1"></i> ‚ö†Ô∏è Allergy info missing
                </span>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Actions -->
      <div class="ms-3 d-flex align-items-center gap-2">
        <a href="{{ url_for('edit_patient', patient_id=patient._id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Edit">
          <i class="bi bi-pencil"></i>
        </a>
        <form method="POST" action="{{ url_for('delete_patient', patient_id=patient._id) }}" onsubmit="return confirm('Delete this patient?');">
          <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
        </form>
      </div>

    </div>
  </div>
  {% endfor %}
</div>

<!-- Scripts -->
<script>
  // Filter by name and company
  const searchInput = document.getElementById("searchInput");
  const companyFilter = document.getElementById("companyFilter");

  function filterPatients() {
    const nameValue = searchInput.value.toLowerCase();
    const companyValue = companyFilter.value.toLowerCase();

    document.querySelectorAll(".patient-card").forEach(card => {
      const name = card.querySelector("h6").textContent.toLowerCase();
      const company = card.getAttribute("data-company").toLowerCase();
      const nameMatch = name.includes(nameValue);
      const companyMatch = !companyValue || company === companyValue;
      card.style.display = (nameMatch && companyMatch) ? "" : "none";
    });
  }

  searchInput.addEventListener("keyup", filterPatients);
  companyFilter.addEventListener("change", filterPatients);

  document.addEventListener("DOMContentLoaded", () => {
    const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.forEach(el => new bootstrap.Tooltip(el));
  });
</script>

{% endblock %}
