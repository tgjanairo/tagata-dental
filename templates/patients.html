{% extends "layout.html" %}
{% block content %}

<!-- Header -->
<div class="bg-primary text-white p-3 d-flex justify-content-between align-items-center rounded-top">
  <h4 class="mb-0"><i class="bi bi-people-fill me-2"></i> Patient List</h4>
  <a href="{{ url_for('add_patient') }}" class="btn btn-light btn-sm fw-bold">
    <i class="bi bi-plus-circle"></i> New Patient
  </a>
</div>

<!-- Container -->
<div class="container py-4">

  <!-- Filters (server-side) -->
  <form class="row g-3 mb-3 align-items-end" method="get" action="{{ url_for('list_patients') }}">
    <!-- Company -->
    <div class="col-md-4">
      <label for="companyFilter" class="form-label mb-1">Company</label>
      <select id="companyFilter" name="company" class="form-select">
        <option value="" {{ ''==company and 'selected' or '' }}>Filter by Company (All)</option>
        {% for c in companies %}
          <option value="{{ c }}" {{ 'selected' if c==company else '' }}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Branch -->
    <div class="col-md-3">
      <label for="branchFilter" class="form-label mb-1">Branch</label>
      <select id="branchFilter" name="branch" class="form-select">
        <option value="" {{ ''==branch and 'selected' or '' }}>Filter by Branch (All)</option>
        <option value="Baguio" {{ 'selected' if branch=='Baguio' else '' }}>Baguio</option>
        <option value="Tarlac"  {{ 'selected' if branch=='Tarlac'  else '' }}>Tarlac</option>
      </select>
    </div>

    <!-- Search -->
    <div class="col-md-4">
      <label for="searchInput" class="form-label mb-1">Search</label>
      <div class="input-group">
        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control border-start-0" id="searchInput" name="q"
               value="{{ q or '' }}" placeholder="Search patients by name...">
      </div>
    </div>

    <!-- Per page -->
    <div class="col-md-1">
      <label class="form-label mb-1">Per</label>
      <select class="form-select" name="per_page">
        {% for n in [10,25,50,100] %}
          <option value="{{ n }}" {{ 'selected' if per_page==n else '' }}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Always reset to page 1 on filter/search change -->
    <input type="hidden" name="page" value="1">
  </form>

  <!-- Server-side count -->
  <p class="text-primary fw-bold text-center mb-2">
    Page {{ page }} â€¢ Showing {{ (page-1)*per_page + 1 }}â€“{{ [page*per_page, total]|min }}
    of {{ total }} patient{{ '' if total==1 else 's' }}
  </p>

  <!-- Patient Cards -->
  {% for patient in patients %}
  <div class="card mb-3 shadow-sm border-0 patient-card">
    <div class="card-body d-flex align-items-center justify-content-between">

      <!-- Left: Avatar & Info -->
      <div class="d-flex align-items-center w-100">
        <img src="https://ui-avatars.com/api/?name={{ patient.first_name }}+{{ patient.last_name }}&background=0D8ABC&color=fff&size=64"
             alt="Avatar" class="avatar rounded-circle me-3">

        <div class="flex-grow-1">
          <h6 class="mb-1 d-flex align-items-center gap-2">
            <a href="{{ url_for('view_patient', patient_id=patient._id) }}"
               class="text-decoration-none fw-semibold text-primary">
              {{ patient.last_name }}, {{ patient.first_name }}
            </a>

            {% set branch_badge = patient.branch or '' %}
            {% if branch_badge %}
              <span class="badge rounded-pill
                {% if branch_badge == 'Baguio' %} bg-primary
                {% elif branch_badge == 'Tarlac' %} bg-success
                {% else %} bg-secondary {% endif %}">
                {{ branch_badge }}
              </span>
            {% endif %}
          </h6>

          <p class="mb-1 text-muted small">{{ patient.contact or 'No contact info' }}</p>

          {% if patient.company %}
            <small class="badge bg-info text-dark mb-1">{{ patient.company }}</small><br>
          {% endif %}

          {% if patient.last_updated %}
            <small class="text-muted d-block">ðŸ•“ Updated: {{ patient.last_updated.strftime('%b %d, %Y') }}</small>
          {% endif %}

          {% if patient.last_procedure and patient.procedure_date %}
            <small class="text-muted d-block">
              ðŸ¦· Last Procedure: {{ patient.last_procedure }} ({{ patient.procedure_date.strftime('%b %d, %Y') }})
            </small>
          {% endif %}

          {# --- Allergy pills: show only if has_allergy --- #}
          {% set items = patient.allergies if patient.allergies is iterable else ([patient.allergies] if patient.allergies else []) %}
          {% set max_badges = 5 %}

          {% if patient.has_allergy %}
            <div class="mt-2">
              {% if items|length > 0 %}
                <div class="d-flex flex-wrap align-items-center gap-1">
                  {% for a in items[:max_badges] %}
                    <span class="badge rounded-pill text-bg-danger">{{ a }}</span>
                  {% endfor %}
                  {% if items|length > max_badges %}
                    <span class="badge rounded-pill text-bg-danger-subtle border"
                          data-bs-toggle="tooltip"
                          title="{{ items|join(', ') }}">
                      +{{ items|length - max_badges }} more
                    </span>
                  {% endif %}
                </div>
              {% else %}
                <span class="badge text-bg-warning">
                  <i class="bi bi-exclamation-triangle me-1"></i> Allergy info missing
                </span>
              {% endif %}
            </div>
          {% endif %}
          {# --- end allergy pills --- #}
        </div>
      </div>

      <!-- Actions -->
      <div class="ms-3 d-flex align-items-center gap-2">
        <a href="{{ url_for('edit_patient', patient_id=patient._id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Edit">
          <i class="bi bi-pencil"></i>
        </a>
        <form method="POST" action="{{ url_for('delete_patient', patient_id=patient._id) }}" onsubmit="return confirm('Delete this patient?');">
          <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
        </form>
      </div>

    </div>
  </div>
  {% endfor %}

  <!-- Pagination -->
  <nav class="d-flex justify-content-between align-items-center mt-3">
    <div class="text-muted small">
      Page {{ page }} â€¢ Showing {{ (page-1)*per_page + 1 }}â€“{{ [page*per_page, total]|min }} of {{ total }}
    </div>
    <div class="btn-group">
      <a class="btn btn-outline-secondary btn-sm {{ 'disabled' if page<=1 }}"
         href="{{ url_for('list_patients', page=page-1, per_page=per_page, q=q, branch=branch, company=company) }}">â€¹ Prev</a>
      <a class="btn btn-outline-secondary btn-sm {{ 'disabled' if page*per_page>=total }}"
         href="{{ url_for('list_patients', page=page+1, per_page=per_page, q=q, branch=branch, company=company) }}">Next â€º</a>
    </div>
  </nav>

</div> <!-- /container -->

<!-- Scripts (auto-submit filters + debounce search; tooltips) -->
<script>
  // submit on select change
  document.querySelectorAll('select[name=company],select[name=branch],select[name=per_page]')
    .forEach(el => el.addEventListener('change', () => el.form.submit()));

  // debounce search
  const q = document.querySelector('input[name="q"]');
  if (q) {
    let t; q.addEventListener('input', () => {
      clearTimeout(t);
      t = setTimeout(() => q.form.submit(), 300);
    });
  }

  // tooltips (for +N more and action buttons)
  document.addEventListener('DOMContentLoaded', () => {
    const tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tips.forEach(el => new bootstrap.Tooltip(el));
  });
</script>

{% endblock %}
