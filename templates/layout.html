<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tagata Dental</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
</head>
<body>

  <div class="wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <h2>ðŸ¦· <span>Tagata Dental</span></h2>

      {% if session.get('user') %}
        <!-- Profile dropdown -->
        <div class="dropdown w-100 my-2">
          <button class="btn btn-dark w-100 d-flex justify-content-between align-items-center dropdown-toggle"
                  type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="text-truncate">{{ session['user']['email'] }}</span>
            <span class="badge bg-secondary ms-2">{{ session['user']['role'] }}</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-dark w-100">
            <li><a class="dropdown-item" href="{{ safe_url_for('account_settings') }}"><i class="bi bi-person-gear me-2"></i>Account Settings</a></li>
            <li><a class="dropdown-item" href="{{ safe_url_for('change_password') }}"><i class="bi bi-key me-2"></i>Change Password</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
          </ul>
        </div>
      {% else %}
        <a class="btn btn-success w-100 my-2" href="{{ url_for('login') }}"><i class="bi bi-box-arrow-in-right me-2"></i>Login</a>
      {% endif %}

      <ul class="nav flex-column mt-2">
        <!-- Dashboard -->
        <li class="nav-item">
          <a href="{{ url_for('dashboard') }}" class="nav-link {% if request.endpoint=='dashboard' %}active{% endif %}">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard
          </a>
        </li>

        <!-- Patients -->
        <a class="nav-link group-toggle d-flex justify-content-between align-items-center"
           data-bs-toggle="collapse" href="#patientsMenu" role="button"
           aria-expanded="{{ 'true' if request.endpoint in ['list_patients','add_patient','view_patient','edit_patient'] else 'false' }}"
           aria-controls="patientsMenu">
          <span><i class="bi bi-people me-2"></i>Patients</span>
          <i class="bi bi-chevron-down small chev"></i>
        </a>
        <div class="collapse {% if request.endpoint in ['list_patients','add_patient','view_patient','edit_patient'] %}show{% endif %}" id="patientsMenu">
          <ul class="nav flex-column ms-3">
            <li class="nav-item">
              <a href="{{ url_for('list_patients') }}" class="nav-link {% if request.endpoint=='list_patients' %}active{% endif %}">All Patients</a>
            </li>
            {% if session.get('user') and session['user'].get('role') == 'admin' %}
            <li class="nav-item">
              <a href="{{ url_for('add_patient') }}" class="nav-link {% if request.endpoint=='add_patient' %}active{% endif %}">Add Patient</a>
            </li>
            {% endif %}
          </ul>
        </div>

        <!-- Appointments -->
        <a class="nav-link group-toggle d-flex justify-content-between align-items-center"
           data-bs-toggle="collapse" href="#apptsMenu" role="button"
           aria-expanded="{{ 'true' if request.endpoint in ['view_appointments','add_appointment','calendar'] else 'false' }}"
           aria-controls="apptsMenu">
          <span><i class="bi bi-calendar2-week me-2"></i>Appointments</span>
          <i class="bi bi-chevron-down small chev"></i>
        </a>
        <div class="collapse {% if request.endpoint in ['view_appointments','add_appointment','calendar'] %}show{% endif %}" id="apptsMenu">
          <ul class="nav flex-column ms-3">
            <li class="nav-item">
              <a href="{{ url_for('view_appointments') }}" class="nav-link {% if request.endpoint=='view_appointments' %}active{% endif %}">View</a>
            </li>
            {% if session.get('user') and session['user'].get('role') == 'admin' %}
            <li class="nav-item">
              <a href="{{ url_for('add_appointment') }}" class="nav-link {% if request.endpoint=='add_appointment' %}active{% endif %}">Add</a>
            </li>
            {% endif %}
            <li class="nav-item">
              <a href="{{ url_for('calendar') }}" class="nav-link {% if request.endpoint=='calendar' %}active{% endif %}">Calendar</a>
            </li>
          </ul>
        </div>

        <!-- Admin -->
        {% if session.get('user') and session['user'].get('role') == 'admin' %}
          <a class="nav-link group-toggle d-flex justify-content-between align-items-center"
             data-bs-toggle="collapse" href="#adminMenu" role="button"
             aria-expanded="{{ 'true' if request.endpoint in ['users_list','register_user','finance_reports'] else 'false' }}"
             aria-controls="adminMenu">
            <span><i class="bi bi-shield-lock me-2"></i>Admin</span>
            <i class="bi bi-chevron-down small chev"></i>
          </a>
          <div class="collapse {% if request.endpoint in ['users_list','register_user','finance_reports'] %}show{% endif %}" id="adminMenu">
            <ul class="nav flex-column ms-3">
              <li class="nav-item"><a href="{{ safe_url_for('users_list') }}" class="nav-link {% if request.endpoint=='users_list' %}active{% endif %}">Users</a></li>
              <li class="nav-item"><a href="{{ safe_url_for('register_user') }}" class="nav-link {% if request.endpoint=='register_user' %}active{% endif %}">Add User</a></li>
              <li class="nav-item"><a href="{{ url_for('finance_reports') }}" class="nav-link {% if request.endpoint=='finance_reports' %}active{% endif %}">Finance Reports</a></li>
            </ul>
          </div>
        {% endif %}
      </ul>
    </nav>

    <!-- Main content -->
    <main class="main-content">
      <!-- TOAST CONTAINER -->
      <div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
        <div id="toast-container"></div>
      </div>

      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Toast Script -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <script>
      (function () {
        var flashes = {{ messages | tojson }};
        document.addEventListener('DOMContentLoaded', function () {
          var toastContainer = document.getElementById('toast-container');
          if (!toastContainer || !Array.isArray(flashes)) return;

          flashes.forEach(function (pair) {
            var category = pair[0] || 'info';
            var message  = pair[1] || '';

            var bgClass = (category === 'success') ? 'success'
                        : (category === 'danger')  ? 'danger'
                        : 'info';

            var iconCls = (category === 'success') ? 'bi-check-circle-fill'
                        : (category === 'danger')  ? 'bi-exclamation-circle-fill'
                        : 'bi-info-circle-fill';

            var toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-white bg-' + bgClass + ' border-0 mb-3';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');

            var html = ''
              + '<div class="d-flex">'
                + '<div class="toast-body">'
                  + '<i class="bi ' + iconCls + ' me-2"></i>'
                  + message
                + '</div>'
                + '<button type="button" class="btn-close btn-close-white me-2 m-auto"'
                + ' data-bs-dismiss="toast" aria-label="Close"></button>'
              + '</div>';

            toastEl.innerHTML = html;
            toastContainer.appendChild(toastEl);

            var bsToast = new bootstrap.Toast(toastEl, { delay: 4000 });
            bsToast.show();
          });
        });
      })();
      </script>
    {% endif %}
  {% endwith %}

  <!-- FullCalendar (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
</body>
</html>
